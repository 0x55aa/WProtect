--utilities
function size_func( op, b_func, w_func, d_func)
    local i = get_operand_size(op)
    if (i == 8) then
        b_func()
    elseif(i == 16) then
        w_func()
    elseif(i == 32) then
        d_func()      
    end
end

function size_func1( op, b_func, w_func, d_func, param)
    local i = get_operand_size(op)
    if (i == 8) then
        b_func(param)
    elseif(i == 16) then
        w_func(param)
    elseif(i == 32) then
        d_func(param)      
    end
end

function size_pop_invalid( op )
    local i = get_operand_size(op)
    if (i == 8) then
        pop(T_INVALID + T_E32X + T_16X + T_8L)
    elseif(i == 16) then
        pop(T_INVALID + T_E32X + T_16X)
    elseif(i == 32) then
        pop(T_INVALID + T_E32X)       
    end
end

--Common Instructions
function nop()
    push_operand(1)
    pop_operand(1)
end

function mov()
    push_operand(2)
    pop_operand(1)
end

function xchg()
    push_operand(2)
    push_operand(1)
    pop_operand(2)
    pop_operand(1)
end

function lea()
    push_operand(2,true)
    pop_operand(1)
end

function push()
    resize_imm_operand(1)
    push_operand(1)
end

function pop()
    resize_imm_operand(1)
    pop_operand(1)
end

function cmp()
    push_operand(2)
    push_operand(1)
    size_func(1, b_sub, w_sub, d_sub)
    popf()
    size_pop_invalid(1)
end

function test()
    resize_imm_operand(2, get_operand_size(1))
    push_operand(1)
    push_operand(2)
    size_func(1, b_and, w_and, d_and)
    popf()
    size_pop_invalid(1)   
end

function add()
    resize_imm_operand(2, get_operand_size(1))
    push_operand(2)
    push_operand(1)
    size_func(1, b_add, w_add, d_add)
    popf()
    pop_operand(1)
end

function sub()
    resize_imm_operand(2,get_operand_size(1))
    push_operand(2)
    push_operand(1)
    size_func(1, b_sub, w_sub, d_sub)
    popf()
    pop_operand(1)
end

function inc()
    push_operand(1)
    size_func1(1, b_push_imm, w_push_imm, d_push_imm, i)
    --to be added

end

function dec()
    --TODO:   
end

function cnot()
    push_operand(1)
    size_func(1, b_not, w_not, d_not)
    popf()
    pop_operand(1)    
end

function cand()
    push_operand(1)
    size_func(1, b_and, w_and, d_and)
    popf()
    pop_operand(1)    
end

function cor()
    push_operand(1)
    size_func(1, b_or, w_or, d_or)
    popf()
    pop_operand(1)    
end

function xor()
    push_operand(1)
    size_func(1, b_xor, w_xor, d_xor)   
    popf()
    pop_operand(1)    
end

function shl()
    push_operand(1) 
    push_operand(2)
    size_func1(1, b_shl, w_shl, d_shl, 1)
    popf()
    pop_operand(1)       
end

function shr()
    push_operand(1) 
    push_operand(2)
    size_func1(1, b_shr, w_shr, d_shr, 1)
    popf()
    pop_operand(1)   
end

function sar()
    push_operand(1)
    push_operand(2)
    size_func1(1, b_sar, w_sar, d_sar, 1)
    popf()
    pop_operand(1)
end

function cdq()
    push(T_EAX)
    b_push_imm(31)
    d_sar()
    pop(T_INVALID)
    pop(T_EDX)
end

function cwd()
    push(T_AX)
    b_push_imm(15)
    w_sar()
    pop(T_INVALID)
    pop(T_EDX)
end

function scasb()
    push(T_EDI)
    b_read_mem()
    push(T_AL)
    b_cmp()
    popf()

    get_string_ins_diff()
    b_push_imm(0)
    d_shl()
    pop(T_INVALID)
    push(T_EDI)
    d_add()
    pop(T_INVALID)
    pop(T_EDI)
end

function scasw()
    push(T_EDI)
    b_read_mem()
    push(T_AX)
    b_cmp()
    popf()

    get_string_ins_diff()
    b_push_imm(1)
    d_shl()
    pop(T_INVALID)
    push(T_EDI)
    d_add()
    pop(T_INVALID)
    pop(T_EDI)
end

function scasd()
    push(T_EDI)
    b_read_mem()
    push(T_EAX)
    b_cmp()
    popf()

    get_string_ins_diff()
    b_push_imm(2)
    d_shl()
    pop(T_INVALID)
    push(T_EDI)
    d_add()
    pop(T_INVALID)
    pop(T_EDI)
end

function movsb()
    push(T_ESI)
    b_read_mem()
    push(T_EDI)
    b_write_men()

    get_string_ins_diff()
    push_vsp()
    d_read_mem()

    push(T_ESI)
    d_add()
    pop(T_INVALID)
    pop(T_ESI)
    
    push(T_EDI)
    d_add()
    pop(T_INVALID)
    pop(T_EDI)
end

function movsd()
    push(T_ESI)
    b_read_mem()
    push(T_EDI)
    b_write_men()

    get_string_ins_diff()
    b_push_imm(2)
    d_shl()
    pop(T_INVALID)
    push_vsp()
    d_read_mem()

    push(T_ESI)
    d_add()
    pop(T_INVALID)
    pop(T_ESI)
    
    push(T_EDI)
    d_add()
    pop(T_INVALID)
    pop(T_EDI)
end

--jcc
function jnz()
    push(T_NEXTINSADDR)
    push(T_JMPINSADDR)
    push_vsp()
    pushf()
    d_push_imm(0x40)
    d_and()
    pop(T_INVALID)
    b_push_imm(4)
    d_shr()
    pop(T_INVALID)
    d_add()
    pop(T_INVALID)
    d_read_mem()
    pop(T_NEXTINSADDR)
    pop(T_INVALID)
    pop(T_INVALID)
end

function jz()
    push(T_JMPINSADDR)
    push(T_NEXTINSADDR)
    push_vsp()
    pushf()
    d_push_imm(0x40)
    d_and()
    pop(T_INVALID)
    b_push_imm(4)
    d_shr()
    pop(T_INVALID)
    d_add()
    pop(T_INVALID)
    d_read_mem()
    pop(T_NEXTINSADDR)
    pop(T_INVALID)
    pop(T_INVALID) 
end

function ja()
    push(T_NEXTINSADDR)
    push(T_JMPINSADDR)
    push_vsp()
    pushf()
    get_cf()
    pushf()
    get_zf()
    d_or()
    pop(T_INVALID)
    d_add()
    pop(T_INVALID)
    d_read_mem()
    pop(T_NEXTINSADDR)
    pop(T_INVALID)
    pop(T_INVALID)
end

function jae()
    push(T_NEXTINSADDR)
    push(T_JMPINSADDR)
    push_vsp()
    pushf()
    get_cf()
    d_add()
    pop(T_INVALID)
    d_read_mem()
    pop(T_NEXTINSADDR)
    pop(T_INVALID)
    pop(T_INVALID)
end

function jb( ... )
    push(T_JMPINSADDR)
    push(T_NEXTINSADDR)
    push_vsp()
    pushf()
    get_cf()
    d_add()
    pop(T_INVALID)
    d_read_mem()
    pop(T_NEXTINSADDR)
    pop(T_INVALID)
    pop(T_INVALID)
end

function jbe()
    push(T_JMPINSADDR)
    push(T_NEXTINSADDR)
    push_vsp()
    pushf()
    get_cf()
    pushf()
    get_zf()
    d_or()
    pop(T_INVALID)
    d_add()
    pop(T_INVALID)
    d_read_mem()
    pop(T_NEXTINSADDR)
    pop(T_INVALID)
    pop(T_INVALID)
end

function jcxz()
    push(T_JMPINSADDR)
    push(T_NEXTINSADDR)
    push_vsp()
    w_push_imm(0)
    push(T_CX)
    w_cmp()
    get_zf()
    d_add()
    pop(T_INVALID)
    d_read_mem()
    pop(T_NEXTINSADDR)
    pop(T_INVALID)
    pop(T_INVALID)
end

function jg()
    push(T_NEXTINSADDR)
    push(T_JMPINSADDR)
    push_vsp()
    pushf()
    get_zf()
    pushf()
    get_sf()
    pushf()
    get_of()
    d_xor()
    pop(T_INVALID)
    d_or()
    pop(T_INVALID)
    d_add()
    pop(T_INVALID)
    d_read_mem()
    pop(T_NEXTINSADDR)
    pop(T_INVALID)
    pop(T_INVALID)
end

--setcc
function setz()
    pushf()
    get_zf()
    b_push_imm(2)
    d_shr()
    pop(T_INVALID) 
    pop_operand(1)
    pop(T_INVALID | T_8L )
    pop(T_INVALID | T_16X)     
end               

function setnz()
    pushf()
    get_zf()
    b_push_imm(2)
    d_shr()
    pop(T_INVALID)
    d_not()
    pop(T_INVALID)
    b_push_imm_zx(1)
    d_and()
    pop(T_INVALID)
    pop_operand(1)
    pop(T_INVALID | T_8L)
    pop(T_INVALID | T_16X)
end

function sets()
    pushf()
    get_sf()
    b_push_imm(2)
    d_shr()
    pop(T_INVALID)
    pop_operand(1)
    pop(T_INVALID | T_8L)
    pop(T_INVALID | T_16X)
end

function setns()
    pushf()
    get_sf()
    b_push_imm(2)
    d_shr()
    pop(T_INVALID)
    d_not()
    pop(T_INVALID)
    b_push_imm_zx(1)
    d_and()
    pop(T_INVALID)
    pop_operand(1)
    pop(T_INVALID | T_8L)
    pop(T_INVALID | T_16X)
end

function setp()
    pushf()
    get_pf()
    b_push_imm(2)
    d_shr()
    pop(T_INVALID)
    pop_operand(1)
    pop(T_INVALID | T_8L)
    pop(T_INVALID | T_16X)
end

function setnp()
    pushf()
    get_pf()
    b_push_imm(2)
    d_shr()
    pop(T_INVALID)
    d_not()
    pop(T_INVALID)
    b_push_imm_zx(1)
    d_and()
    pop(T_INVALID)
    pop_operand(1)
    pop(T_INVALID | T_8L)
    pop(T_INVALID | T_16X)
end

function seto()
    pushf()
    get_of()
    b_push_imm(2)
    d_shr()
    pop(T_INVALID)
    pop_operand(1)
    pop(T_INVALID | T_8L)
    pop(T_INVALID | T_16X)
end

function setno()
    pushf()
    get_of()
    b_push_imm(2)
    d_shr()
    pop(T_INVALID)
    d_not()
    pop(T_INVALID)
    b_push_imm_zx(1)
    d_and()
    pop(T_INVALID)
    pop_operand(1)
    pop(T_INVALID | T_8L)
    pop(T_INVALID | T_16X)
end

function setb()
    pushf()
    get_cf()
    b_push_imm(2)
    d_shr()
    pop(T_INVALID)
    pop_operand(1)
    pop(T_INVALID | T_8L)
    pop(T_INVALID | T_16X) 
end

function setae()
    pushf()
    get_cf()
    b_push_imm(2)
    d_shr()
    pop(T_INVALID)
    d_not()
    pop(T_INVALID)
    b_push_imm_zx(1)
    d_and()
    pop(T_INVALID)
    pop_operand(1)
    pop(T_INVALID | T_8L)
    pop(T_INVALID | T_16X)
end

function seta()
    pushf()
    get_cf()
    b_push_imm(2)
    d_shr()
    pop(T_INVALID)
    d_not()
    pop(T_INVALID)
    pushf()
    get_zf()
    b_push_imm(2)
    d_shr()
    pop(T_INVALID)
    d_not()
    pop(T_INVALID)
    d_and()
    pop(T_INVALID)
    b_push_imm_zx(1)
    d_and()
    pop(T_INVALID)
    pop_operand(1)
    pop(T_INVALID | T_8L)
    pop(T_INVALID | T_16X) 
end

function setbe()
    pushf()
    get_cf()
    b_push_imm(2)
    d_shr()
    pop(T_INVALID)
    d_not()
    pop(T_INVALID)
    pushf()
    get_zf()
    b_push_imm(2)
    d_shr()
    pop(T_INVALID)
    d_not()
    pop(T_INVALID)
    d_and()
    pop(T_INVALID)
    d_not()
    pop(T_INVALID)
    b_push_imm_zx(1)
    d_and()
    pop(T_INVALID)
    pop_operand(1)
    pop(T_INVALID | T_8L)
    pop(T_INVALID | T_16X)    
end

function setg()
    pushf()
    get_zf()
    b_push_imm(2)
    d_shr()
    pop(T_INVALID)
    d_not()
    pop(T_INVALID)
    pushf()
    get_sf()
    b_push_imm(2)
    d_shr()
    pop(T_INVALID)
    pushf()
    get_of()
    b_push_imm(2)
    d_shr()
    pop(T_INVALID)
    d_xor()
    pop(T_INVALID)
    d_not()
    pop(T_INVALID)
    d_and()
    pop(T_INVALID)
    b_push_imm_zx(1)
    d_and()
    pop(T_INVALID)
    pop_operand(1)
    pop(T_INVALID | T_8L)
    pop(T_INVALID | T_16X)  
end

function setge()
    pushf()
    get_sf()
    pushf()
    get_of()
    d_xor()
    pop(T_INVALID)
    d_not()
    pop(T_INVALID)
    b_push_imm(2)
    d_shr()
    pop(T_INVALID)
    pop_operand(1)
    pop(T_INVALID | T_8L)
    pop(T_INVALID | T_16X)  
end

function setle()
    pushf()
    get_sf()
    pushf()
    get_of()
    d_xor()
    pop(T_INVALID)
    pushf()
    get_zf()
    d_and()
    pop(T_INVALID)
    b_push_imm(2)
    d_shr()
    pop(T_INVALID)
    b_push_imm(2)
    d_shr()
    pop(T_INVALID)
    pop_operand(1)
    pop(T_INVALID | T_8L)
    pop(T_INVALID | T_16X)   
end

function setl()
    pushf()
    get_sf()
    pushf()
    get_of()
    d_xor()
    pop(T_INVALID)
    b_push_imm(2)
    d_shr()
    pop(T_INVALID)
    pop_operand(1)
    pop(T_INVALID | T_8L)
    pop(T_INVALID | T_16X)       
end